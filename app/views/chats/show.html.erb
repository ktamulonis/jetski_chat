<div class="chats-card chats-show sidebar-collapsed" data-sidebar-container>
  <% @chats = Chat.all if @chats.nil? %>

  <button
    type="button"
    class="sidebar-toggle"
    aria-label="Toggle sidebar"
    aria-expanded="false"
    data-sidebar-toggle
  >
    <span class="icon-open" aria-hidden="true">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M4 6H20M4 12H20M4 18H20"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
        />
      </svg>
    </span>
    <span class="icon-close" aria-hidden="true">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M6 6L18 18M6 18L18 6"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
        />
      </svg>
    </span>
  </button>

  <aside class="left-panel">
    <h2>Chats</h2>

    <div class="chat-list">
      <div class="new-chat">
        <form action="/chats" method="post">
          <button type="submit" class="new-chat-btn">+ New Chat</button>
        </form>
      </div>
      <% if Array(@chats).any? %>
        <div class="delete-all">
          <form action="/chats-delete-all" method="post">
            <button type="submit" class="delete-all-btn">Delete All</button>
          </form>
        </div>
      <% end %>

      <ul>
        <% if Array(@chats).empty? %>
          <li class="muted">No chats yet</li>
        <% end %>

        <% Array(@chats).each do |c| %>
          <li>
            <div class="chat-row">
              <a
                href="/chats/<%= c.id %>"
                class="<%= 'active' if c.id == @chat.id %>"
              >
                <%= (c.title && c.title.strip.size > 0) ? c.title : "Untitled" %>
              </a>
              <form action="/chat-delete" method="post">
                <input type="hidden" name="chat_id" value="<%= c.id %>" />
                <button
                  type="submit"
                  class="delete-chat-btn"
                  aria-label="Delete chat"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      d="M6 7H18M9 7V5H15V7M10 11V17M14 11V17M7 7L8 19H16L17 7"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </form>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
  </aside>

  <main
    class="right-panel"
    data-chat-id="<%= @chat.id %>"
    data-image-mode="<%= @chat.respond_to?(:image_mode) ? @chat.image_mode.to_i : 0 %>"
  >
    <div class="chat-topbar">
      <div class="chat-topbar-title">Chat</div>
      <div class="chat-topbar-actions">
        <button
          type="button"
          class="image-toggle"
          data-image-toggle
          aria-pressed="false"
        >
          Image: Off
        </button>
        <button
          type="button"
          class="gallery-toggle"
          data-gallery-toggle
          aria-label="Open gallery"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path
              d="M4 6H20V18H4V6Z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linejoin="round"
            />
            <path
              d="M8 10H16"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M8 14H14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          <span class="gallery-count" data-gallery-count>0</span>
        </button>
      </div>
    </div>

    <div class="chat-header">
      <h2><%= @chat.title %></h2>
    </div>

    <!-- ========================================================= -->
    <!-- Messages -->
    <!-- ========================================================= -->
    <div class="messages-wrapper">
      <div class="messages" id="jetski-messages">
        <% Array(@messages).each do |message| %>
          <% pending = message.role == "assistant" && message.content.to_s.strip == "" %>
          <div
            class="message <%= message.role %><%= pending ? " is-pending" : "" %>"
            data-jetski-model="Message"
            data-jetski-id="<%= message.id %>"
          >
            <div class="message-header">
              <strong><%= message.role %>:</strong>
              <% if message.role == "user" %>
                <button
                  type="button"
                  class="message-edit"
                  data-message-edit
                  aria-label="Retry message"
                  title="Retry message"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      d="M20 6V12H14M4 18V12H10"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M6.5 8.5C8 6.5 10.3 5 12.8 5C16.2 5 19 7.8 19 11.2M5 12.8C5 16.2 7.8 19 11.2 19C13.7 19 16 17.5 17.5 15.5"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                  />
                </svg>
                </button>
                <% if Message.attribute_names.include?(:iterations_total) && message.respond_to?(:iterations_total) && message.iterations_total.to_i > 1 %>
                  <span class="message-iterations">
                    Runs
                    <span data-jetski-attr="iterations_completed"><%= message.iterations_completed.to_i %></span>
                    /
                    <span data-jetski-attr="iterations_total"><%= message.iterations_total.to_i %></span>
                  </span>
                <% end %>
              <% end %>
            </div>

            <div class="message-content" data-jetski-attr="content">
              <%= ERB::Util.html_escape(message.content.to_s) %>
            </div>
          </div>
        <% end %>
      </div>

      <button
        type="button"
        class="scroll-to-bottom"
        id="scroll-to-bottom"
        aria-label="Scroll to latest messages"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            d="M12 5V19M12 19L7 14M12 19L17 14"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>
    </div>

    <!-- ========================================================= -->
    <!-- Message form -->
    <!-- ========================================================= -->
    <form class="message-form" action="/messages" method="post">
      <input type="hidden" name="chat_id" value="<%= @chat.id %>" />
      <input
        type="hidden"
        name="image_mode"
        value="<%= @chat.respond_to?(:image_mode) && @chat.image_mode.to_i == 1 ? "1" : "0" %>"
        data-image-mode-input
      />
      <input type="hidden" name="iterations_value" value="1" data-iterations-value />

      <div class="message-input-wrap">
        <textarea
          name="content"
          placeholder="Type your message..."
          autofocus
          required
        ></textarea>
        <button
          type="button"
          class="input-menu-toggle"
          aria-label="Message options"
          data-input-menu-toggle
        >
          <span aria-hidden="true">•••</span>
        </button>
        <div class="input-menu" data-input-menu hidden>
          <label class="iteration-control" title="Repeat the same prompt multiple times. Shortcut: Ctrl+Shift+1-9">
            <span>Runs</span>
            <input
              type="number"
              min="1"
              max="9"
              step="1"
              value="1"
              name="iterations"
              data-iterations-input
            />
          </label>
          <div class="iterations-hint" data-iterations-hint>
            Tip: Ctrl+Shift+1-9 repeats this prompt.
          </div>
        </div>
      </div>

      <div class="send-btn-wrap">
        <button
          type="submit"
          class="send-btn"
          aria-label="Send"
          title="Ctrl+Shift+Enter to send"
        >
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            d="M2 21L23 12L2 3L2 10L17 12L2 14L2 21Z"
            fill="currentColor"
          />
        </svg>
        </button>
        <div class="send-hint" data-send-hint>Tip: Ctrl+Shift+Enter to send</div>
      </div>
    </form>

    <div class="iteration-status" data-iteration-status hidden>
      <div class="iteration-status-row">
        <div class="iteration-status-label" data-iteration-status-label>
          Running 0 of 0
        </div>
        <button
          type="button"
          class="iteration-cancel"
          data-iteration-cancel
        >
          Cancel
        </button>
      </div>
      <div class="iteration-status-bar">
        <div class="iteration-status-fill" data-iteration-status-fill></div>
      </div>
    </div>
  </main>

  <div class="gallery-overlay" data-gallery-overlay hidden>
    <button type="button" class="gallery-close" data-gallery-close aria-label="Close gallery">
      <svg
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <path
          d="M6 6L18 18M6 18L18 6"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
        />
      </svg>
    </button>
    <div class="gallery-timeline" data-gallery-timeline></div>
    <div class="gallery-stage">
      <button type="button" class="gallery-nav prev" data-gallery-prev aria-label="Previous image"></button>
      <img data-gallery-image alt="Gallery image" />
      <button type="button" class="gallery-nav next" data-gallery-next aria-label="Next image"></button>
    </div>
    <div class="gallery-meta">
      <div class="gallery-counter" data-gallery-counter>0 / 0</div>
      <button type="button" class="gallery-autoplay" data-gallery-autoplay>Autoplay</button>
      <label class="gallery-speed">
        Speed
        <input
          type="range"
          min="0.2"
          max="10"
          step="0.1"
          value="2"
          data-gallery-interval
        />
        <span data-gallery-interval-label>2.0s</span>
      </label>
      <label class="gallery-transparent">
        <input type="checkbox" data-gallery-transparent />
        Transparent BG
      </label>
      <div class="gallery-key">
        <span class="gallery-key-label">Palette</span>
        <input type="color" value="#ffffff" data-gallery-key-color />
        <span class="gallery-key-auto">
          <input type="checkbox" checked data-gallery-key-auto />
          Auto
        </span>
        <div class="gallery-key-list" data-gallery-key-list></div>
        <button type="button" class="gallery-key-clear" data-gallery-key-clear>
          Clear
        </button>
      </div>
      <label class="gallery-tolerance">
        Tolerance
        <input
          type="range"
          min="0.02"
          max="0.6"
          step="0.01"
          value="0.2"
          data-gallery-tolerance
        />
        <span data-gallery-tolerance-label>0.20</span>
      </label>
      <button type="button" class="gallery-download" data-gallery-download>Download GIF</button>
      <button type="button" class="gallery-delete" data-gallery-delete>Delete image</button>
    </div>
  </div>
</div>
